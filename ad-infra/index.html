<!DOCTYPE html>
<html lang="cs">
    <head>
        <meta charset="utf-8">
        <title> Attack/Defence infrastruktura Českého týmu na ECSC </title>
        <link rel="stylesheet" href="/assets/reveal.js/dist/reveal.css">
        <link rel="stylesheet" href="/assets/reveal.js/dist/theme/black.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
        <!--
        :root {
            --r-heading-font: 'ISOCPEUR';
            --r-main-font: 'DINosaur';
            --r-background-color: #bb0500;
            --r-heading-color: #ccaa00;
            --r-link-color: #ccaa00;
            --r-link-color-dark: #977d00;
            --r-link-color-hover: #ccaa00;
        }
        -->
        <style>
        :root {
            --r-heading-font: 'Montserrat';
            --r-main-font: 'Montserrat';
            --r-background-color: #000d1b;
            --r-heading-color: #fff;
            --r-link-color: #0d6efd;
        }
        .reveal a:hover {
            text-decoration: underline;
        }
        .fragment.disappear {
            visibility: visible !important;
            opacity: 1 !important;
            display: inline-block;
            trainsition: width 1s ease;
            white-space: nowrap;
            width: 7.3em;
        }
        .fragment.disappear.visible {
            visibility: hidden !important;
            opacity: 0 !important;
            width: 0 !important;
        }
        .attribution {
            display: inline-block;
        }
        .attribution a {
            color: white;
            display: block;
            font-size: small;
            text-align: right;
            z-index: -1;
        }
        .attribution img {
            margin-bottom: 0;
        }
        .in {
            color: #00cc33;
        }
        .enemy {
            color: #ff1133;
        }
        .out {
            color: #0070ff;
        }
        ul {
            margin-left: 0 !important;
        }
        a.fn {
            font-variant-position: super;
            counter-increment: fn;
        }
        a.fn::after {
            content: "[↗]";
        }


        </style>
    </head>
    <body>
        <div class="reveal">
            <div class="slides">
                <section data-background-image="assets/title.jpg" data-background-opacity="0.3">
                    <h3>Attack/Defence infrastruktura Českého týmu na ECSC</h3>
                    <p style="font-size: .6em">Jan Černohorský</p>
                    <p>Slidy najdete na <a href="https://talks.grsc.cz/ad-infra">talks.grsc.cz/ad-infra</a></p>
                </section>
                <section>
                    <h1>ECSC?</h1>
                    <section>
                        <p class="fragment"><span class="fragment strike">European Coal and Steel Community</span></p>
                        <p class="fragment"><span class="fragment strike">Eurovision Cover Song Contest</span></p>
                        <p class="fragment"><span> European Cybersecurity Challenge</span></p>
                    </section>
                    <section>
                        <p>Organizuje <a href="https://www.enisa.europa.eu/">ENISA</a></p>
                        <p>Desetičlenné týmy do 26 let (min. 5 do 20)</p>
                        <p>Česká kvalifikace je <a style="color: black; background-color: #ffff00; font-family: Arial" href="https://kybersoutez.cz">Kybersoutěž</a></p>
                        <p>Existuje <a href="https://open.ecsc2024.it/">OpenECSC</a> (každý rok jiné)</p>
                    </section>
                    <section data-background-image="assets/czechcyberteam.jpeg"> </section>
                </section>
                <section>
                    <section>
                        <h3>Attack/Defence?</h3>
                    </section>
                    <section>
                        <div style="display: flex; flex-direction: row; justify-content: center;">
                            <img src='assets/attack-defence-1.svg' width=350>
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto">
                                <h4>Obránci</h4>
                                <ul style="font-size: smaller">
                                    <li>přístup na vulnbox po SSH</li>
                                    <li>typicky root (ne vždy)</li>
                                    <li>služby neznají dopředu</li>
                                </ul>
                                <p></p>
                                <h4>Útočníci</h4>
                                <ul style="font-size: smaller">
                                    <li>přistupují přímo ke službám</li>
                                    <li>většinou HTTP nebo Raw TCP</li>
                                    <li>většinou dostanou zdroják</li>
                                </ul>
                            </div>
                        </div>
                    </section>
                    <section>
                        <div style="display: flex; flex-direction: row; justify-content: center;">
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 1em">
                                <h4>Flagbot</h4>
                                <ul style="font-size: 0.8em">
                                    <li>umisťuje vlajky do služeb</li>
                                    <li>kontroluje jejich přítomnost</li>
                                    <li>⇒ přiděluje body za <strong>uptime</strong></li>
                                    <li>chová se jako „normální uživatel“</li>
                                </ul>
                                <p></p>
                                <h4>Útočníci</h4>
                                <ul style="font-size: smaller">
                                    <li>kradou vlajky ze služeb</li>
                                    <li>odevzdávají gameserveru</li>
                                    <li>⇒ přiděluje body za <strong>útok</strong></li>
                                </ul>
                            </div>
                            <img src='assets/flag-bot.svg' width=350>
                        </div>
                    </section>
                    <section>
                        <div style="display: flex; flex-direction: row; justify-content: center; font-size: smaller">
                            <div>
                                <img src='assets/flag-bot-icon.svg' width=80>
<pre style="margin: 0 1em">
<span class="out">&gt;</span> POST /register
<span class="in" >&lt;</span> 200 OK

<span class="out">&gt;</span> POST /notes/private
<span class="out">&gt;</span> 
<span class="out">&gt;</span> ECSC_080A02AF0J07UMOPHNE00KJ48KAE28C=
<span class="in" >&lt;</span> 201 Created
<span class="in" >&lt;</span>
<span class="in" >&lt;</span> New note ID: 12

...

<span class="out">&gt;</span> GET /notes/private
<span class="in" >&lt;</span> 200 OK
<span class="in" >&lt;</span>
<span class="in" >&lt;</span> Note 12: ECSC_080A02AF0J07UMOPHNE00KJ48KAE28C=
</pre>
                            </div>
                            <div>
                                <img src='assets/attacker-icon.svg' width=80>
<pre style="margin: 0 1em">
<span class="enemy">&gt;</span> GET /notes/private/1
<span class="in"   >&lt;</span> 404 Not Found
<span class="enemy">&gt;</span> GET /notes/private/2
<span class="in"   >&lt;</span> 404 Not Found

...

<span class="enemy">&gt;</span> GET /notes/private/11
<span class="in"   >&lt;</span> 404 Not Found
<span class="enemy">&gt;</span> GET /notes/private/12
<span class="in"   >&lt;</span> 200 OK
<span class="in"   >&lt;</span>
<span class="in"   >&lt;</span> Note 12: ECSC_080A02AF0J07UMOPHNE00KJ48KAE28C=
</pre>
                            </div>
                        </div>
                    </section>
                    <section>
                        <div style="display: flex; flex-direction: row; justify-content: center;">
                            <img src='assets/nat.svg' width=400>
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto">
                                <h4>Router</h4>
                                <ul style="font-size: smaller">
                                    <li>veškerý provoz jde skrz</li>
                                    <li>NATuje (i na IPv6)</li>
                                    <li>(resetuje TTL)</li>
                                    <li>(normalizuje HTTP hlavičky)</li>
                                </ul>
                                <p>Vulnbox nesmí poznat,<br> s kým se baví!</p>
                            </div>
                        </div>
                    </section>
                    <section>
                        <h4>Reálná soutěž</h4>
                        <p style="font-size: smaller">mnoho týmů, každý útočí a brání zároveň</p>
                        <p style="font-size: smaller">existuje NOP tým</p>
                        <img src='assets/network.svg' width=600>
                    </section>
                    <section>
                        <h4>Ticky</h4>
                        <ul style="font-size: smaller">
                            <li>Celá hra probíhá v ticích</li>
                            <li>Typicky 1 – 3 minuty</li>
                            <li>V jednom ticku</li>
                            <ul>
                                <li>flagbot přidá do služby 1 vlajku</li>
                                <li>flagbot zkontroluje <em>n</em>¹ posledních vlajek</li>
                            </ul>
                            <li>Útočníci útočí kdykoliv – častěji to ale nemá smysl</li>
                        </ul>
                        <img src="assets/flag-bot-put.svg" class="fragment" style="margin: .5em" width=250>
                        <img src="assets/flag-bot-get.svg" class="fragment" style="margin: .5em" width=250>
                        <img src="assets/attacker-get.svg" class="fragment" style="margin: .5em" width=250>
                        <p style="font-size: .5em">¹ typicky 3 – 6</p>
                    </section>
                    <section>
                        <h4>Skórování</h4>
                        <ul style="font-size: smaller">
                            <li>skóre se počítá za každý tick</li>
                            <ul>
                                <li><span style="color:green">+</span> body za uptime = <strong>SLA</strong></li>
                                <ul><li><span style="color:green">up</span>, <span style="color:magenta">faulty</span>, <span style="color:red">down</span>, <span style="color:#06f">check fail</span>, <span style="color:#fb0">recovering</span></li></ul>
                                <li><span style="color:green">+</span> body za ukradené vlajky = <strong>offence</strong></li>
                                <li><span style="color:red">-</span> body za ztracené vlajky = <strong>defence</strong></li>
                            </ul>
                            <li>dynamické skóre</li>
                            <ul>
                                <li>vlajka, kterou kradou všichni je za málo bodů</li>
                            </ul>
                        </ul>
                    </section>
                    <section data-background-iframe="https://ad.ecsc2024.it/team/czech">

                    </section>
                    <section>
                        <h4>Flag submission</h4>
                        <ul style="font-size: smaller">
                            <li>útočníci musí útočit pořád</li>
                            <li>FAUST: 1 vlajka × 8 služeb × ~100 týmů / 3 minuty</li>
                            <li>ECSC 2024: 1 vlajka × 8 služeb × 38 týmů / 2 minuty</li>
                            <li>jednoduché HTTP/TCP</li>
                            <pre><code class="python" style="font-size: 0.8em;">
import requests

TEAM_TOKEN = '4242424242424242'

flags = ['AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=', 'BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB=']

print(requests.put('http://10.10.0.1:8080/flags', headers={
    'X-Team-Token': TEAM_TOKEN
}, json=flags).text)
                            </code></pre>
                        </ul>
                    </section>
                    <section>
                        <h4>Flag IDs</h4>
                        <ul style="font-size: smaller">
                            <li>jednoznačně určují, kde je konkrétní vlajka</li>
                            <ul>
                                <li>username vlastníka poznámky</li>
                                <li>ID dokumentu</li>
                                <li>souřadnice vesmírné lodi</li>
                                <li>číslo objednávky</li>
                            </ul>
                        </ul>
                    </section>
                    <section>
                        <h4>Grace period</h4>
                        <p>Čas kdy týmy mají přístup k vulnboxu, ale není otevřená síť</p>
                        <p>Obvykle ½ – 1 hodina</p>
                    </section>
                </section>
                <section>
                    <h3>Quirky pravidel</h3>
                    <section>
                        Různá CTF mají různá pravidla
                    </section>
                    <section>
                        <h4>Přístup k vulnboxu</h4>
                        <table>
                            <tr><th><h5>DIY</h5></th><th><h5 style="white-space: nowrap">Full access</h5></th><th><h5>git only</h5></th></tr>
                            <tr>
                                <td style="vertical-align: top; padding-left: 0; padding-right: 0">
                                    <ul style="font-size: 0.5em">
                                        <li>orgové připraví image</li>
                                        <li>týmy si hostují vulnbox</li>
                                        <li>připojení pomocí VPN</li>
                                        <li>patche aplikují týmy</li>
                                        <ul>
                                            <li>FaustCTF</li>
                                        </ul>
                                    </ul>
                                </td>
                                <td style="vertical-align: top; padding-left: 0; padding-right: 0">
                                    <ul style="font-size: 0.5em">
                                        <li>orgové hostují vulnboxy</li>
                                        <li>mohou mít přístup</li>
                                        <li>týmy mají root</li>
                                        <ul>
                                            <li>ECSC 2024</li>
                                            <li>RabaCTF</li>
                                            <li>ENOWARS (TODO: check)</li>
                                        </ul>
                                    </ul>
                                </td>
                                <td style="vertical-align: top; padding-left: 0; padding-right: 0">
                                    <ul style="font-size: 0.5em">
                                        <li>týmy nemají přístup vůbec</li>
                                        <li>změny se pushují přes git</li>
                                        <li>z webUI se deployují commity</li>
                                        <ul>
                                            <li>ECSC 2022</li>
                                            <li>ECSC 2023</li>
                                        </ul>
                                    </ul>
                                </td>
                            </tr>
                            <aside class="notes">
                                <ul>
                                    <li>ECSC 2022: full git only</li>
                                    <li>ECSC 2023: userspace access to vulnbox? TODO</li
                                </ul>
                            </aside>
                        </table>
                    </section>
                    <section>
                        <h4>Smí se shazovat?</h4>
                        <table>
                            <tr><th><h5>Ano, ale ne DoS</h5></th><th><h5>Ne</h5></th></tr>
                            <tr>
                                <td style="vertical-align: top; padding-left: 0; padding-right: 0">
                                    <ul style="font-size: 0.5em">
                                        <li>nesmí se zatěžovat služby a síť</li>
                                        <ul>
                                            <li>ani zranitelnostmi</li>
                                        </ul>
                                        <li>smí se zranitelností shodit služba</li>
                                        <li>smí se mazat vlajky</li>
                                        <ul>
                                            <li>FaustCTF</li>
                                            <li>ECSC 2023</li>
                                        </ul>
                                    </ul>
                                </td>
                                <td style="vertical-align: top; padding-left: 0; padding-right: 0">
                                    <ul style="font-size: 0.5em">
                                        <li>cizí tým nesmí kazit SLA</li>
                                        <ul>
                                            <li>ECSC 2024</li>
                                            <li>RabaCTF</li>
                                            <li>ENOWARS (TODO: check)</li>
                                        </ul>
                                    </ul>
                                </td>
                            </tr>
                        </table>
                    </section>
                    <section>
                        <h4>Dynamické skórování</h4>
                        <table>
                            <ul style="font-size: smaller">
                                <li>vlajka má pevné body, dělí se mezi týmy</li>
                                <li>vlajka má cenu podle aktuální pozice týmů</li>
                                <ul>
                                    <li>ECSC 2024</li>
                                    <li>slabý tým útočí na silný = hodně bodů</li>
                                </ul>
                            </ul>
                        </table>
                    </section>
                </section>
                <section>
                    <section>
                        <h4 class="fragment strike">Servicebox</h4>
                        <h4 class="fragment">Buďkyber!</h4>
                    </section>
                    <section>
                        <h4>Buďkyber</h4>
                        <ul style="font-size: smaller">
                            <li>(virtuální) server</li>
                            <li>hostuje různé služby, které tým potřebuje</li>
                            <li>je taky připojený ve VPN (jako hráč)</li>
                        </ul>
                    </section>
                    <section>
                        <h4>Tulip 🌷<a href="https://github.com/OpenAttackDefenseTools/tulip" class="fn"></a></h4>
                        <ul style="font-size: smaller">
                            <li><strong>flow-based</strong> network monitoring</li>
                            <li>z vulnboxu se posílají <code>.pcap</code>y</li>
                            <li>ty se skládají a indexují do databáze</li>
                            <li>webové rozhraní</li>
                            <ul>
                                <li>vyhledávání</li>
                                <li>sdílení</li>
                                <li>grafy</li>
                                <li>copy as</li>
                            </ul>
                            <li>původně TeamEU (rdj 🇳🇱, Bazumo 🇨🇭, Šimon 🇨🇿)</li>
                            <li>velký pull request od CCT 🇨🇿, primárně Tonda</li>
                        </ul>
                    </section>
                    <section>
                        TODO: Tulip iframe here
                    </section>
                    <section>
                        <h3>DestructiveFarm <img src="assets/df.png" style="height: 1em; vertical-align: center; margin: 0"></h3>
                        <ul style="font-size: smaller">
                            <li>exploit management</li>
                            <ul>
                                <li>rozesílá flagIDs</li>
                                <li>sbírá vlajky</li>
                                <li>odesílá gameserveru</li>
                                <li>zaznamenává úspěšnost</li>
                                <li>řídí, na koho se útočí</li>
                            </ul>
                            <li><strong>distribuované</strong> spouštění exploitů</li>
                            <li>původně Ruského týmu Destructive Voice</li>
                            <li>většina týmů má vlastní, silně přepsanou variantu</li>
                        </ul>
                    </section>
                    <section>
                        TODO: DF iframe here
                    </section>
                    <section>
                        <h4>Exploit runner</h4>
                        <ul style="font-size: smaller">
                            <li>klientská knihovna pro DF</li>
                            <li>hráč napíše jednoduchý skript na kradení vlajky = <strong>exploit</strong></li>
                            <li>runner:</li>
                            <ul>
                                <li>řeší komunikaci s DF</li>
                                <li>spustí mnoho instancí exploitu paralelně</li>
                                <li>extrahuje vlajky z std. out</li>
                            </ul>
                        </ul>
                    </section>
                    <section>
                        <h4>Runner v1</h4>
                        <ul style="font-size: smaller">
                            <li>per-team</li>
                            <li>JSON v <code>argv</code>, vlajky stdout</li>
                        </ul>
                        <pre style="font-size: .3em"><code class="python">
target = json.loads(sys.argv[1])
team_id = target["id"]
flag_ids = target.get("flag_ids", {})
time = target.get("time")

# Example of flag_ids: {
#   'service-1': [ 'flag-id-1', 'flag-id-2' ]
#   'service-2': [ 'flag-id-3', 'flag-id-4' ]
# }

flag_ids = flag_ids['service-1']

host = f"10.10.{team_id}.3"

# Anything printed to stdout or stderr is regex matched to find valid flags
# Flags are extracted and sent to the server
# Non-flag output is just printed on the client
print(f"Attacking {team_id=} at {host=}")

for flag_id in flag_ids:
    r = requests.get(f"http://{host}:3000/users/{flag_id}").text
    print(r)
                        </code></pre>
                    </section>
                    <section>
                        <h4>Runner v2</h4>
                        <ul style="font-size: smaller">
                            <li>per-flagID</li>
                            <li>server poskytuje host info</li>
                        </ul>
                        <pre style="font-size: .3em;"><code class="python">
info = json.loads(sys.argv[1]) if len(sys.argv) &gt; 1 else {}

team_id = info.get("team_id")
service = info.get("service")
# Note that this could be `None` if DF doesn't provide host info
host = info.get("host")
# Flag id is present if the script is set to run per flag id
flag_id = info.get("flag_id")

# Anything printed to stdout or stderr is regex matched to find valid flags
# Flags are extracted and sent to the server
# Non-flag output is just printed out on the client
print(f"Attacking {service=} of {team_id=} at {host=} with {flag_id=}")

# Example: Generating some flags
# NOTE: These example flags will likely not be matched by your flag regex

r = requests.get(f"http://{host}:3000/users/{flag_id}").text
print(r)
                        </code></pre>
                        <ul style="font-size: .7em;" class="fragment">
                            <li>~10 flagIDs × 100 týmů = 1000 exploitů běžících paralelně</li>
                            <li>typicky v pythonu ⇒ 1000 běžicích interpretů</li>
                        </ul>
                    </section>
                    <section>
                        <h4>Runner v3</h4>
                        <pre style="font-size: .25em; transform: scale(1.2); top: 2em;"><code class="python">
from exploitlib import *

# class Team(id: str, name: str | None, display: str, metadata: dict[str, Any], services: dict[str, Service])
# class Service(id: str, name: str | None, host: str | None, metadata: dict[str, Any], flag_ids: list[FlagId])
# class FlagId(id: int, content: str, service: Service, team: Team, info: dict[str, Any], received: datetime, has_flag: bool)

class Exploit(ExploitBase):
    def process_tick(self) -&gt; None:
        # This is called exacly once per attack_period
        # This is the first method to be called
        # State (stuff assigned to self) created here will be usable in process_team and process_flag_id
        print("Exploit.process_tick")

    def process_team(self, team: Team, service: Service | None) -&gt; None:
        # This is called once for each team every attack_period
        # This will not be execute in --single-instance mode
        # State (stuff assigned to self) created here will be usable in process_flag_id
        print(f"Exploit.process_team: {team.display}, {service.display if service else None}")

    def process_flag_id(self, team: Team, service: Service, flag_id: FlagId) -&gt; None:
        # This is called once for each flag id of every team every attack_period
        # This will not be execute in --single-instance and --per-team modes
        # State (stuff assigned to self) created here will be usable only here
        print(f"Exploit.process_flag_id: {team.display}, {service.display}, {flag_id.id}")

if __name__ == "__main__":
    main(Exploit)
                        </code></pre>
                    </section>
                    <section>
                        <h4>Rozdělování času exploitům</h4>
                        <ul style="font-size: smaller">
                            <li>některé exploity jen komunikují po síti</li>
                            <li>→ služby mohou leakovat spojení</li>
                            <li>jiné exploity bruteforcují krypto</li>
                            <li>→ potřebují běžet dlouho</li>
                        </ul>
                        <p>↓</p>
                        <ul style="font-size: smaller" class="fragment">
                            <li>vlajky mají expiraci</li>
                            <li>jak <span class="fragment strike">férově</span> rozdělit čas mezi exploity?</li>
                            <li class="fragment">abychom získali nejvíc bodů?</li>
                        </ul>
                    </section>
                    <section>
                        <h4>Statek <img src="assets/statek.svg" style="height: 1em; margin: 0"></h4>
                        <ul style="font-size: 0.7em">
                            <li>sbírá data z různých zdrojů</li>
                            <ul>
                                <li>DF</li>
                                <li>Scoreboard</li>
                            </ul>
                            <li>dopočítává užitečné metriky</li>
                            <ul>
                                <li>jaké týmy kradou vlajky konkrétní služby?</li>
                                <li>jaké týmy neztrácí vlajky?</li>
                                <li>ztrácime víc bodů za defense než dostáváme za SLA?</li>
                            </ul>
                            <li>zobrazuje v Grafaně</li>
                        </ul>
                    </section>
                </section>
                <section>
                    Join us!
                </section>
                <section>
                    <h4>Odkazy</h4>
                    ...
                </section>

            </div>
        </div>
        <script src="/assets/reveal.js/dist/reveal.js"></script>
        <script src="/assets/reveal.js/dist/"></script>
        <script src="/assets/reveal.js/plugin/notes/notes.js"></script>
        <link rel="stylesheet" href="/assets/reveal.js/plugin/highlight/monokai.css" />
        <script src="/assets/reveal.js/plugin/highlight/highlight.js"></script>
        <script>
        (async function () {
            await Reveal.initialize({
                controlsTutorial: false,
                controlsLayout: 'edges',
                hash: true,
                plugins: [RevealNotes, RevealHighlight],


                dependencies: [
                    { src: '/assets/reveal.js/plugin/math/math.js', async: true }
                ]
            });
            await Reveal.layout()
        })();
        </script>
    </body>
</html>
